<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="theme-color" content="#fde7f3">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link id="app-favicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöö</text></svg>">
    <title>U-AUBEN INVENTORY APP</title>
    
    <link href="tailwind.min.css" rel="stylesheet">
    <script src="lucide.min.js"></script>
    <script src="marked.min.js"></script>
    
    <style>
        @import url('https://fonts.cdnfonts.com/css/algerian');
        @import url('https://fonts.cdnfonts.com/css/monotype-corsiva');

        body { font-family: 'Inter', sans-serif; }
        .main-container {
            max-width: 1024px;
            margin: auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #fde7f3;
            background-image: radial-gradient(#e5e7eb 0.5px, transparent 0.5px);
            background-size: 15px 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow-x: hidden;
        }
        .font-algerian { font-family: 'Algerian', sans-serif; }
        .font-monotype-corsiva { font-family: 'Monotype Corsiva', sans-serif; font-weight: 600; }
        .header-btn {
            background-color: #b91c1c;
            color: white;
            padding: 12px;
            border-radius: 9999px;
            font-weight: 600;
            text-align: center;
            width: 80%;
            margin: 16px auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .main-content { flex-grow: 1; overflow-y: auto; padding: 0 16px 16px; }
        .nav-btn {
            background-color: #1e3a8a;
            color: white;
            padding: 14px;
            border-radius: 9999px;
            font-weight: 500;
            text-align: center;
            margin-top: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.3s;
        }
        .nav-btn:hover { background-color: #1e40af; }
        #side-menu { transition: transform 0.3s ease-in-out; background-color: #7f1d1d; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .chat-message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 12px;
            word-wrap: break-word;
        }
        .chat-message-user {
            background-color: #1e3a8a;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .chat-message-aube {
            background-color: #f3f4f6;
            color: #1f2937;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
    </style>
</head>
<body>

<div id="main-app-container" class="main-container">
    <!-- √âcran Accueil -->
    <div id="screen-home" class="flex flex-col h-full">
        <div class="flex-shrink-0 px-4 pt-4">
            <div class="bg-red-700 text-white rounded-full flex justify-between items-center p-3 shadow-md">
                <button onclick="toggleMenu()" class="text-white"><i data-lucide="menu"></i></button>
                <h1 class="font-semibold text-sm">U-AUBEN INVENTORY</h1>
                <button onclick="navigateTo('screen-settings')" class="text-white"><i data-lucide="settings"></i></button>
            </div>
        </div>

        <div class="flex-grow overflow-y-auto px-4">
            <div class="relative my-4">
                <input type="search" id="search-input" placeholder="Rechercher un produit..." 
                    class="w-full bg-white rounded-full pl-10 pr-12 py-2 border-2 border-gray-200 focus:outline-none focus:border-blue-500 shadow-inner">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                <button onclick="navigateTo('screen-chat-aube')" class="absolute right-4 top-1/2 -translate-y-1/2 text-blue-600">
                    <i data-lucide="bot"></i>
                </button>
            </div>

            <div class="text-center mb-6">
                <div class="bg-blue-900 text-white inline-block px-6 py-3 rounded-2xl shadow-md font-algerian">
                    INVENTAIRE UNIVERSITAIRE
                </div>
            </div>

            <div class="space-y-4" id="inventory-list">
                <p class="text-center text-gray-500">Chargement de l'inventaire...</p>
            </div>
            
            <div class="h-24"></div>
        </div>

        <!-- Bottom Nav -->
        <div class="fixed bottom-0 left-0 right-0 bg-white shadow-lg rounded-t-3xl p-4">
            <div class="flex justify-around items-center max-w-md mx-auto">
                <button onclick="navigateTo('screen-home')" class="flex flex-col items-center text-blue-900">
                    <i data-lucide="home"></i>
                    <span class="text-xs mt-1">Accueil</span>
                </button>
                <button onclick="navigateTo('screen-add-product')" class="flex flex-col items-center text-gray-600">
                    <i data-lucide="plus-circle"></i>
                    <span class="text-xs mt-1">Ajouter</span>
                </button>
                <button onclick="navigateTo('screen-notes')" class="flex flex-col items-center text-gray-600">
                    <i data-lucide="file-text"></i>
                    <span class="text-xs mt-1">Notes</span>
                </button>
                <button onclick="navigateTo('screen-chat-aube')" class="flex flex-col items-center text-gray-600">
                    <i data-lucide="bot"></i>
                    <span class="text-xs mt-1">Aube</span>
                </button>
            </div>
        </div>
    </div>

    <!-- √âcran Ajouter Produit -->
    <div id="screen-add-product" class="hidden flex-col h-full">
        <div class="flex-shrink-0 p-4 flex justify-between items-center bg-white shadow-sm">
            <button onclick="goBack()" class="text-gray-600"><i data-lucide="arrow-left"></i></button>
            <h1 class="font-bold text-xl">Ajouter un produit</h1>
            <div></div>
        </div>
        
        <div class="main-content space-y-4">
            <input id="product-name" type="text" placeholder="Nom du produit" 
                class="w-full bg-white rounded-full px-4 py-3 border-2 border-gray-200 focus:outline-none focus:border-blue-500">
            <input id="product-quantity" type="number" placeholder="Quantit√©" 
                class="w-full bg-white rounded-full px-4 py-3 border-2 border-gray-200 focus:outline-none focus:border-blue-500">
            <input id="product-unit" type="text" placeholder="Unit√© (pcs, kg, litres...)" 
                class="w-full bg-white rounded-full px-4 py-3 border-2 border-gray-200 focus:outline-none focus:border-blue-500">
            
            <button onclick="saveProduct()" class="nav-btn w-full mt-6">Enregistrer</button>
        </div>
    </div>

    <!-- √âcran Notes -->
    <div id="screen-notes" class="hidden flex-col h-full">
        <div class="flex-shrink-0 p-4 flex justify-between items-center bg-white shadow-sm">
            <button onclick="goBack()" class="text-gray-600"><i data-lucide="arrow-left"></i></button>
            <h1 class="font-bold text-xl">Notes</h1>
            <button onclick="navigateTo('screen-add-note')" class="text-blue-600"><i data-lucide="plus"></i></button>
        </div>
        
        <div class="main-content" id="notes-list">
            <p class="text-center text-gray-500 mt-10">Aucune note</p>
        </div>
    </div>

    <!-- √âcran Ajouter Note -->
    <div id="screen-add-note" class="hidden flex-col h-full">
        <div class="flex-shrink-0 p-4 flex justify-between items-center bg-white shadow-sm">
            <button onclick="goBack()" class="text-gray-600"><i data-lucide="arrow-left"></i></button>
            <h1 class="font-bold text-xl">Nouvelle note</h1>
            <div></div>
        </div>
        
        <div class="main-content space-y-4">
            <input id="note-category" type="text" placeholder="Cat√©gorie" 
                class="w-full bg-white rounded-full px-4 py-3 border-2 border-gray-200 focus:outline-none focus:border-blue-500">
            <textarea id="note-content" rows="6" placeholder="Contenu de la note..." 
                class="w-full bg-white rounded-2xl px-4 py-3 border-2 border-gray-200 focus:outline-none focus:border-blue-500"></textarea>
            
            <button onclick="saveNote()" class="nav-btn w-full">Enregistrer</button>
        </div>
    </div>

    <!-- √âcran Chat Aube -->
    <div id="screen-chat-aube" class="hidden flex-col h-full">
        <div class="flex-shrink-0 p-4 flex justify-between items-center bg-gradient-to-r from-purple-600 to-blue-600 text-white shadow-lg">
            <button onclick="goBack()" class="text-white"><i data-lucide="arrow-left"></i></button>
            <div class="flex items-center space-x-2">
                <i data-lucide="bot"></i>
                <h1 class="font-bold text-xl">Aube IA</h1>
            </div>
            <button onclick="clearChat()" class="text-white"><i data-lucide="trash-2"></i></button>
        </div>
        
        <div id="chat-messages" class="flex-grow overflow-y-auto p-4 space-y-3">
            <div class="chat-message chat-message-aube">
                <p>üëã Bonjour ! Je suis Aube, votre assistant IA pour g√©rer l'inventaire. Comment puis-je vous aider aujourd'hui ?</p>
            </div>
        </div>

        <div class="flex-shrink-0 p-4 bg-white border-t">
            <div class="flex space-x-2">
                <input id="chat-input" type="text" placeholder="Posez votre question..." 
                    class="flex-grow bg-gray-100 rounded-full px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()" class="bg-blue-600 text-white rounded-full p-3 hover:bg-blue-700">
                    <i data-lucide="send"></i>
                </button>
            </div>
            <div id="connection-status" class="text-xs text-center mt-2 text-gray-500"></div>
        </div>
    </div>

    <!-- √âcran Settings -->
    <div id="screen-settings" class="hidden flex-col h-full">
        <div class="flex-shrink-0 p-4 flex justify-between items-center bg-white shadow-sm">
            <button onclick="goBack()" class="text-gray-600"><i data-lucide="arrow-left"></i></button>
            <h1 class="font-bold text-xl">Param√®tres</h1>
            <div></div>
        </div>
        
        <div class="main-content space-y-4">
            <div class="bg-white rounded-2xl p-4 shadow">
                <h3 class="font-semibold mb-2">Cl√© API Gemini</h3>
                <input id="gemini-api-key" type="password" placeholder="Entrez votre cl√© API..." 
                    class="w-full bg-gray-100 rounded-lg px-4 py-2">
                <button onclick="saveAPIKey()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-lg">Enregistrer</button>
            </div>
            
            <div class="bg-white rounded-2xl p-4 shadow">
                <h3 class="font-semibold mb-2">Base de donn√©es</h3>
                <button onclick="exportDB()" class="w-full bg-green-600 text-white py-2 rounded-lg mb-2">Exporter</button>
                <button onclick="clearDB()" class="w-full bg-red-600 text-white py-2 rounded-lg">R√©initialiser</button>
            </div>
        </div>
    </div>

    <!-- Side Menu -->
    <div id="side-menu" class="fixed top-0 left-0 h-full w-80 bg-red-900 text-white transform -translate-x-full z-50 shadow-2xl">
        <div class="p-6">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold">Menu</h2>
                <button onclick="toggleMenu()" class="text-white"><i data-lucide="x"></i></button>
            </div>
            
            <nav class="space-y-4">
                <button onclick="navigateTo('screen-home'); toggleMenu();" class="w-full text-left p-3 rounded-lg hover:bg-red-800 flex items-center space-x-3">
                    <i data-lucide="home"></i>
                    <span>Accueil</span>
                </button>
                <button onclick="navigateTo('screen-add-product'); toggleMenu();" class="w-full text-left p-3 rounded-lg hover:bg-red-800 flex items-center space-x-3">
                    <i data-lucide="plus-circle"></i>
                    <span>Ajouter produit</span>
                </button>
                <button onclick="navigateTo('screen-notes'); toggleMenu();" class="w-full text-left p-3 rounded-lg hover:bg-red-800 flex items-center space-x-3">
                    <i data-lucide="file-text"></i>
                    <span>Notes</span>
                </button>
                <button onclick="navigateTo('screen-settings'); toggleMenu();" class="w-full text-left p-3 rounded-lg hover:bg-red-800 flex items-center space-x-3">
                    <i data-lucide="settings"></i>
                    <span>Param√®tres</span>
                </button>
            </nav>
        </div>
    </div>
    
    <div id="menu-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40" onclick="toggleMenu()"></div>
</div>

<script type="module">
    import { CapacitorSQLite, SQLiteConnection } from '@capacitor-community/sqlite';
    
    // Variables globales
    let db = null;
    let sqliteConnection = null;
    let chatHistory = [];
    let currentScreen = 'screen-home';
    let navigationHistory = [];
    
    // Initialisation au chargement
    document.addEventListener('DOMContentLoaded', async () => {
        lucide.createIcons();
        await initDatabase();
        await loadInventory();
        await loadNotes();
        checkConnection();
        setInterval(checkConnection, 5000);
    });
    
    // === DATABASE FUNCTIONS ===
    async function initDatabase() {
        try {
            sqliteConnection = new SQLiteConnection(CapacitorSQLite);
            db = await sqliteConnection.createConnection('u_auben_inventory', false, 'no-encryption', 1, false);
            await db.open();
            
            // Create tables
            await db.execute(`
                CREATE TABLE IF NOT EXISTS inventory (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    product_name TEXT NOT NULL,
                    quantity INTEGER NOT NULL,
                    unit TEXT,
                    last_updated DATETIME DEFAULT CURRENT_TIMESTAMP
                );
            `);
            
            await db.execute(`
                CREATE TABLE IF NOT EXISTS notes (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    content TEXT NOT NULL,
                    date DATETIME DEFAULT CURRENT_TIMESTAMP,
                    category TEXT
                );
            `);
            
            console.log('‚úÖ Base de donn√©es initialis√©e');
        } catch (error) {
            console.error('‚ùå Erreur DB:', error);
        }
    }
    
    async function saveProduct() {
        const name = document.getElementById('product-name').value.trim();
        const quantity = parseInt(document.getElementById('product-quantity').value);
        const unit = document.getElementById('product-unit').value.trim();
        
        if (!name || !quantity) {
            alert('Veuillez remplir tous les champs');
            return;
        }
        
        try {
            await db.run(`INSERT INTO inventory (product_name, quantity, unit) VALUES (?, ?, ?)`, 
                [name, quantity, unit]);
            
            document.getElementById('product-name').value = '';
            document.getElementById('product-quantity').value = '';
            document.getElementById('product-unit').value = '';
            
            await loadInventory();
            navigateTo('screen-home');
        } catch (error) {
            console.error('Erreur:', error);
            alert('Erreur lors de l\'enregistrement');
        }
    }
    
    async function loadInventory() {
        try {
            const result = await db.query('SELECT * FROM inventory ORDER BY last_updated DESC');
            const container = document.getElementById('inventory-list');
            
            if (!result.values || result.values.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">Aucun produit dans l\'inventaire</p>';
                return;
            }
            
            container.innerHTML = result.values.map(item => `
                <div class="bg-white rounded-2xl p-4 shadow-md flex justify-between items-center">
                    <div>
                        <h3 class="font-semibold text-lg">${item.product_name}</h3>
                        <p class="text-gray-600">${item.quantity} ${item.unit || 'pcs'}</p>
                    </div>
                    <button onclick="deleteProduct(${item.id})" class="text-red-600">
                        <i data-lucide="trash-2"></i>
                    </button>
                </div>
            `).join('');
            
            lucide.createIcons();
        } catch (error) {
            console.error('Erreur chargement:', error);
        }
    }
    
    window.deleteProduct = async function(id) {
        if (!confirm('Supprimer ce produit ?')) return;
        try {
            await db.run('DELETE FROM inventory WHERE id = ?', [id]);
            await loadInventory();
        } catch (error) {
            console.error('Erreur:', error);
        }
    };
    
    async function saveNote() {
        const content = document.getElementById('note-content').value.trim();
        const category = document.getElementById('note-category').value.trim();
        
        if (!content) {
            alert('Veuillez entrer du contenu');
            return;
        }
        
        try {
            await db.run('INSERT INTO notes (content, category) VALUES (?, ?)', [content, category]);
            document.getElementById('note-content').value = '';
            document.getElementById('note-category').value = '';
            await loadNotes();
            navigateTo('screen-notes');
        } catch (error) {
            console.error('Erreur:', error);
        }
    }
    
    async function loadNotes() {
        try {
            const result = await db.query('SELECT * FROM notes ORDER BY date DESC');
            const container = document.getElementById('notes-list');
            
            if (!result.values || result.values.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 mt-10">Aucune note</p>';
                return;
            }
            
            container.innerHTML = result.values.map(note => `
                <div class="bg-white rounded-2xl p-4 shadow-md mb-4">
                    ${note.category ? `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${note.category}</span>` : ''}
                    <p class="mt-2">${note.content}</p>
                    <p class="text-xs text-gray-500 mt-2">${new Date(note.date).toLocaleDateString()}</p>
                </div>
            `).join('');
        } catch (error) {
            console.error('Erreur:', error);
        }
    }
    
    // === AUBE IA - HYBRID MODE ===
    async function sendMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        if (!message) return;
        
        // Add user message
        addChatMessage(message, 'user');
        input.value = '';
        
        // Show typing indicator
        const typingDiv = document.createElement('div');
        typingDiv.className = 'chat-message chat-message-aube';
        typingDiv.id = 'typing-indicator';
        typingDiv.innerHTML = '<div class="flex space-x-1"><div class="typing-indicator"></div><div class="typing-indicator"></div><div class="typing-indicator"></div></div>';
        document.getElementById('chat-messages').appendChild(typingDiv);
        document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
        
        // Get inventory data for context
        const inventoryData = await getInventoryForAI();
        
        // Try online mode first
        const isOnline = navigator.onLine;
        const apiKey = localStorage.getItem('gemini_api_key');
        
        if (isOnline && apiKey) {
            await processOnlineMode(message, inventoryData, apiKey);
        } else {
            await processOfflineMode(message, inventoryData);
        }
        
        document.getElementById('typing-indicator')?.remove();
    }
    
    async function getInventoryForAI() {
        try {
            const result = await db.query('SELECT * FROM inventory');
            if (!result.values || result.values.length === 0) {
                return "L'inventaire est actuellement vide.";
            }
            return result.values.map(item => 
                `${item.product_name}: ${item.quantity} ${item.unit || 'pcs'}`
            ).join(', ');
        } catch (error) {
            return "Erreur de lecture de l'inventaire.";
        }
    }
    
    async function processOnlineMode(message, inventoryData, apiKey) {
        try {
            const systemPrompt = `Tu es Aube, l'assistant IA pour la gestion d'inventaire U-AUBEN. 
Inventaire actuel: ${inventoryData}
R√©ponds de mani√®re concise et utile. Si l'utilisateur demande des informations sur un produit, utilise les donn√©es de l'inventaire.`;
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: `${systemPrompt}\n\nUtilisateur: ${message}`
                        }]
                    }]
                })
            });
            
            const data = await response.json();
            const aubeResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || 
                "D√©sol√©, je n'ai pas pu traiter votre demande.";
            
            addChatMessage(aubeResponse, 'aube');
        } catch (error) {
            console.error('Erreur API:', error);
            await processOfflineMode(message, inventoryData);
        }
    }
    
    async function processOfflineMode(message, inventoryData) {
        const lowerMsg = message.toLowerCase();
        let response = '';
        
        // Pattern matching pour les requ√™tes simples
        if (lowerMsg.includes('combien') || lowerMsg.includes('stock') || lowerMsg.includes('quantit√©')) {
            try {
                const result = await db.query('SELECT * FROM inventory');
                if (result.values && result.values.length > 0) {
                    const productMatch = result.values.find(item => 
                        lowerMsg.includes(item.product_name.toLowerCase())
                    );
                    
                    if (productMatch) {
                        response = `üîµ Aube (Offline): Il reste ${productMatch.quantity} ${productMatch.unit || 'pcs'} de ${productMatch.product_name}.`;
                    } else {
                        response = `üîµ Aube (Offline): Voici l'inventaire complet: ${inventoryData}`;
                    }
                } else {
                    response = "üîµ Aube (Offline): L'inventaire est vide.";
                }
            } catch (error) {
                response = "üîµ Aube (Offline): Erreur de lecture de la base de donn√©es.";
            }
        } else if (lowerMsg.includes('liste') || lowerMsg.includes('inventaire')) {
            response = `üîµ Aube (Offline): ${inventoryData}`;
        } else if (lowerMsg.includes('bonjour') || lowerMsg.includes('salut')) {
            response = "üîµ Aube (Offline): Bonjour ! Je peux vous aider √† consulter votre inventaire m√™me sans connexion Internet.";
        } else {
            response = `üîµ Aube (Offline): Je fonctionne en mode hors ligne. Je peux vous donner des informations sur votre inventaire: ${inventoryData}`;
        }
        
        addChatMessage(response, 'aube');
    }
    
    function addChatMessage(text, sender) {
        const messagesDiv = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message chat-message-${sender}`;
        messageDiv.innerHTML = `<p>${text}</p>`;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    window.clearChat = function() {
        if (confirm('Effacer la conversation ?')) {
            document.getElementById('chat-messages').innerHTML = `
                <div class="chat-message chat-message-aube">
                    <p>üëã Bonjour ! Je suis Aube, votre assistant IA pour g√©rer l'inventaire. Comment puis-je vous aider aujourd'hui ?</p>
                </div>
            `;
            chatHistory = [];
        }
    };
    
    window.sendMessage = sendMessage;
    
    // === NAVIGATION ===
    window.navigateTo = function(screenId) {
        // Hide all screens
        document.querySelectorAll('[id^="screen-"]').forEach(screen => {
            screen.classList.add('hidden');
        });
        
        // Show target screen
        const targetScreen = document.getElementById(screenId);
        if (targetScreen) {
            navigationHistory.push(currentScreen);
            currentScreen = screenId;
            targetScreen.classList.remove('hidden');
            targetScreen.classList.add('flex');
            lucide.createIcons();
        }
    };
    
    window.goBack = function() {
        if (navigationHistory.length > 0) {
            const previousScreen = navigationHistory.pop();
            navigateTo(previousScreen);
        } else {
            navigateTo('screen-home');
        }
    };
    
    window.toggleMenu = function() {
        const menu = document.getElementById('side-menu');
        const overlay = document.getElementById('menu-overlay');
        
        if (menu.classList.contains('-translate-x-full')) {
            menu.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
        } else {
            menu.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        }
    };
    
    // === SETTINGS ===
    window.saveAPIKey = function() {
        const key = document.getElementById('gemini-api-key').value.trim();
        if (key) {
            localStorage.setItem('gemini_api_key', key);
            alert('Cl√© API enregistr√©e !');
        }
    };
    
    window.exportDB = async function() {
        try {
            const inventory = await db.query('SELECT * FROM inventory');
            const notes = await db.query('SELECT * FROM notes');
            
            const exportData = {
                inventory: inventory.values || [],
                notes: notes.values || [],
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `u-auben-backup-${Date.now()}.json`;
            link.click();
            
            alert('Export r√©ussi !');
        } catch (error) {
            console.error('Erreur export:', error);
            alert('Erreur lors de l\'export');
        }
    };
    
    window.clearDB = async function() {
        if (!confirm('‚ö†Ô∏è Effacer toutes les donn√©es ? Cette action est irr√©versible.')) return;
        
        try {
            await db.execute('DELETE FROM inventory');
            await db.execute('DELETE FROM notes');
            await loadInventory();
            await loadNotes();
            alert('Base de donn√©es r√©initialis√©e');
        } catch (error) {
            console.error('Erreur:', error);
        }
    };
    
    // === CONNECTION STATUS ===
    function checkConnection() {
        const statusDiv = document.getElementById('connection-status');
        if (statusDiv) {
            statusDiv.textContent = navigator.onLine ? 'üü¢ En ligne - Mode IA complet' : 'üîµ Hors ligne - Mode Aube Lite';
        }
    }
    
    window.addEventListener('online', checkConnection);
    window.addEventListener('offline', checkConnection);
    
    // Export functions
    window.saveProduct = saveProduct;
    window.saveNote = saveNote;
</script>

</body>
</html>
